<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <!-- è‹¹æœæ ¸å¿ƒé€‚é…ï¼šå…¨å±+é˜²ç¼©æ”¾+æ— åç§» -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, shrink-to-fit=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="æç®€è®°è´¦æœ¬">
    <!-- è‹¹æœæ¡Œé¢å›¾æ ‡ç¾åŒ– -->
    <link rel="apple-touch-icon" href="https://img.icons8.com/fluency/180/000000/money-bag.png">
    <title>æç®€è®°è´¦æœ¬ - å½“æœˆæ”¶æ”¯</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "å¾®è½¯é›…é»‘", sans-serif;
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }
        body {
            background-color: #f5f7fa;
            padding: env(safe-area-inset-top) 12px env(safe-area-inset-bottom) 12px;
            max-width: 800px;
            margin: 0 auto;
            color: #111827;
            min-height: 100vh;
        }
        body.dark {
            background-color: #111827;
            color: #f9fafb;
        }
        .app-container {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 0 20px rgba(0,0,0,0.08);
            padding: 20px 18px;
            width: 100%;
        }
        body.dark .app-container {
            background: #1f2937;
            box-shadow: 0 0 20px rgba(0,0,0,0.3);
        }
        .page-nav {
            display: flex;
            gap: 6px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .nav-btn {
            padding: 9px 12px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            background-color: #e5e7eb;
            color: #2d3748;
            flex: 1;
            min-width: 90px;
        }
        body.dark .nav-btn {
            background-color: #374151;
            color: #f9fafb;
        }
        .nav-btn.active {
            background-color: #3b82f6;
            color: #fff !important;
        }
        body.dark .nav-btn.active {
            background-color: #2563eb;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 18px;
            flex-wrap: wrap;
            gap:10px;
        }
        h1 {
            color: #2d3748;
            font-size: 22px;
        }
        body.dark h1 {
            color: #f9fafb;
        }
        .header-actions {
            display: flex;
            gap: 8px;
        }
        .theme-btn, .export-btn {
            padding: 7px 10px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-size: 13px;
            margin-top: 0;
            width: auto;
        }
        .theme-btn {
            background-color: #e5e7eb;
            color: #2d3748;
        }
        body.dark .theme-btn {
            background-color: #374151;
            color: #f9fafb;
        }
        .export-btn {
            background-color: #10b981;
            color: #fff;
        }
        .export-btn:hover {
            background-color: #059669;
        }
        /* ç»Ÿè®¡é¢æ¿é€šç”¨æ ·å¼ï¼šé¦–é¡µ+æŸ¥è¯¢é¡µå…±ç”¨ */
        .stats {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            margin-bottom: 18px;
        }
        .stats-item {
            flex: 1;
            padding: 15px 8px;
            border-radius: 8px;
            text-align: center;
        }
        .income {
            background-color: #e8f5e9;
            color: #22c55e;
        }
        body.dark .income {
            background-color: #166534;
            color: #4ade80;
        }
        .expense {
            background-color: #fef2f2;
            color: #ef4444;
        }
        body.dark .expense {
            background-color: #7f1d1d;
            color: #fca5a5;
        }
        .balance {
            background-color: #eff6ff;
            color: #3b82f6;
            border: 1px solid #bfdbfe;
        }
        body.dark .balance {
            background-color: #1e40af;
            color: #93c5fd;
            border-color: #3b82f6;
        }
        .stats-item h3 {
            font-size: 13px;
            margin-bottom: 6px;
            opacity: 0.8;
        }
        .stats-item p {
            font-size: 20px;
            font-weight: bold;
        }
        /* æŸ¥è¯¢é¡µå•ç‹¬ç»Ÿè®¡æ æ ·å¼ */
        .filter-stats {
            margin-bottom: 15px;
        }
        .filter-stats-item {
            padding: 12px;
            border-radius: 8px;
            text-align: center;
        }
        .filter-wrap {
            margin-bottom: 20px;
        }
        .time-filter-box {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        .cate-filter-box {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        .filter-item {
            flex: 1;
            min-width: 140px;
        }
        .filter-item label {
            display: block;
            font-size: 13px;
            color: #4b5563;
            margin-bottom: 5px;
            width: 100%;
            font-weight: 500;
        }
        body.dark .filter-item label {
            color: #d1d5db;
        }
        .expense-label {
            color: #ef4444 !important;
        }
        body.dark .expense-label {
            color: #fca5a5 !important;
        }
        .income-label {
            color: #22c55e !important;
        }
        body.dark .income-label {
            color: #4ade80 !important;
        }
        .filter-select {
            width: 100%;
            padding: 8px 10px;
            border-radius: 6px;
            border: 1px solid #d1d5db;
            background-color: #fff;
            color: #4b5563;
            cursor: pointer;
            font-size: 13px;
            outline: none;
            appearance: auto;
        }
        body.dark .filter-select {
            background-color: #374151;
            border-color: #4b5563;
            color: #f9fafb;
        }
        .form-box {
            border-top: 1px solid #e5e7eb;
            border-bottom: 1px solid #e5e7eb;
            padding: 20px 0;
            margin-bottom: 18px;
        }
        body.dark .form-box {
            border-color: #374151;
        }
        .form-group {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
            align-items: center;
        }
        .form-group label {
            width: 70px;
            font-size: 15px;
            color: #4b5563;
        }
        body.dark .form-group label {
            color: #d1d5db;
        }
        select, input {
            flex: 1;
            padding: 9px 10px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 15px;
            outline: none;
            background-color: #fff;
            color: #111827;
        }
        body.dark select, body.dark input {
            background-color: #374151;
            border-color: #4b5563;
            color: #f9fafb;
        }
        button {
            width: 100%;
            padding: 11px;
            background-color: #3788fb;
            color: #fff;
            border: none;
            border-radius: 6px;
            font-size: 15px;
            cursor: pointer;
            margin-top: 8px;
        }
        button:hover {
            background-color: #2563eb;
        }
        .bill-list {
            margin-top: 18px;
        }
        .bill-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 8px;
            border-bottom: 1px solid #f3f4f6;
        }
        body.dark .bill-item {
            border-color: #374151;
        }
        .bill-item:last-child {
            border-bottom: none;
        }
        .bill-info {
            flex: 1;
        }
        .bill-tag {
            display: inline-flex;
            gap: 6px;
            margin-bottom: 4px;
        }
        .bill-type {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
        }
        .bill-type.income-type {
            background-color: #e8f5e9;
            color: #22c55e;
        }
        body.dark .bill-type.income-type {
            background-color: #166534;
            color: #4ade80;
        }
        .bill-type.expense-type {
            background-color: #fef2f2;
            color: #ef4444;
        }
        body.dark .bill-type.expense-type {
            background-color: #7f1d1d;
            color: #fca5a5;
        }
        .bill-category {
            font-size: 11px;
            color: #6b7280;
            background-color: #f3f4f6;
            padding: 2px 6px;
            border-radius: 4px;
        }
        body.dark .bill-category {
            background-color: #374151;
            color: #d1d5db;
        }
        .bill-money {
            font-size: 16px;
            font-weight: bold;
            margin: 4px 0;
        }
        .bill-money.income-money {
            color: #22c55e;
        }
        .bill-money.expense-money {
            color: #ef4444;
        }
        .bill-desc {
            font-size: 13px;
            color: #6b7280;
            margin: 2px 0;
        }
        body.dark .bill-desc {
            color: #9ca3af;
        }
        .bill-time {
            font-size: 11px;
            color: #9ca3af;
        }
        body.dark .bill-time {
            color: #6b7280;
        }
        .bill-actions {
            display: flex;
            gap: 8px;
        }
        .edit-btn {
            color: #f59e0b;
            cursor: pointer;
            font-size: 12px;
        }
        .del-btn {
            color: #ef4444;
            cursor: pointer;
            font-size: 12px;
        }
        body.dark .edit-btn {
            color: #fbbf24;
        }
        body.dark .del-btn {
            color: #f87171;
        }
        .empty-tip {
            text-align: center;
            padding: 25px;
            color: #9ca3af;
            font-size: 14px;
        }
        body.dark .empty-tip {
            color: #6b7280;
        }
        .page {
            display: none;
        }
        .page.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        input, select {
            font-size: 16px !important;
            -webkit-text-size-adjust: 100%;
        }
        input[type="number"] {
            -webkit-appearance: none;
            appearance: none;
        }
    </style>
</head>
<body class="light">
    <div class="app-container">
        <div class="page-nav">
            <button class="nav-btn active" data-page="page1">ğŸ’° è®°è´¦é¦–é¡µ</button>
            <button class="nav-btn" data-page="page2">ğŸ“Š æ”¯å‡ºæŸ¥è¯¢</button>
            <button class="nav-btn" data-page="page3">ğŸ“ˆ æ”¶å…¥æŸ¥è¯¢</button>
        </div>

        <!-- ============= ç¬¬ä¸€é¡µé¢ã€çº¯è®°è´¦é¡µã€‘- åªæ˜¾ç¤ºå½“æœˆæ”¶æ”¯ ============= -->
        <div class="page active" id="page1">
            <div class="header">
                <h1>æç®€è®°è´¦æœ¬ - å½“æœˆæ”¶æ”¯</h1>
                <div class="header-actions">
                    <button class="theme-btn" id="themeBtn">åˆ‡æ¢æ·±è‰²æ¨¡å¼</button>
                    <button class="export-btn" id="exportBtn">å¯¼å‡ºå…¨éƒ¨è®°å½•</button>
                </div>
            </div>
            <div class="stats">
                <div class="stats-item income">
                    <h3>å½“æœˆæ€»æ”¶å…¥</h3>
                    <p id="totalIncome">Â¥ 0.00</p>
                </div>
                <div class="stats-item expense">
                    <h3>å½“æœˆæ€»æ”¯å‡º</h3>
                    <p id="totalExpense">Â¥ 0.00</p>
                </div>
                <div class="stats-item balance">
                    <h3>å½“æœˆä½™é¢</h3>
                    <p id="totalBalance">Â¥ 0.00</p>
                </div>
            </div>
            <div class="form-box">
                <div class="form-group">
                    <label>æ”¶æ”¯ç±»å‹</label>
                    <select id="billType">
                        <option value="expense">æ”¯å‡º</option>
                        <option value="income">æ”¶å…¥</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>æ”¶æ”¯åˆ†ç±»</label>
                    <!-- æ”¯å‡ºåˆ†ç±»ä¸‹æ‹‰æ¡†ï¼šæŒ‰è°ƒæ•´åé¡ºåºæ’åˆ— -->
                    <select id="billCategory">
                        <option value="å€Ÿæ”¯">å€Ÿæ”¯</option>
                        <option value="é¤é¥®">é¤é¥®</option>
                        <option value="è´­ç‰©">è´­ç‰©</option>
                        <option value="ç½‘è´­">ç½‘è´­</option>
                        <option value="æ²¹è´¹">æ²¹è´¹</option>
                        <option value="ç”µè´¹">ç”µè´¹</option>
                        <option value="é¦™çƒŸ">é¦™çƒŸ</option>
                        <option value="æ¸¸æˆ">æ¸¸æˆ</option>
                        <option value="å…¶ä»–æ”¯å‡º">å…¶ä»–æ”¯å‡º</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>é‡‘é¢(å…ƒ)</label>
                    <input type="number" id="billMoney" placeholder="è¯·è¾“å…¥é‡‘é¢ï¼Œä¾‹å¦‚ï¼š50.5" step="0.01" min="0.01" required>
                </div>
                <div class="form-group">
                    <label>å¤‡æ³¨è¯´æ˜</label>
                    <input type="text" id="billDesc" placeholder="ä¾‹å¦‚ï¼šå€ŸXXé’±ã€æ”¶XXè¿˜æ¬¾ã€æ—©é¤...">
                </div>
                <button id="submitBtn">æ·»åŠ è®°è´¦è®°å½•</button>
            </div>
        </div>

        <!-- ============= ç¬¬äºŒé¡µé¢ã€æ”¯å‡ºæŸ¥è¯¢é¡µã€‘- ç­›é€‰åæ€»æ”¯å‡ºç»Ÿè®¡ï¼ˆå«å€Ÿæ”¯ï¼‰ ============= -->
        <div class="page" id="page2">
            <div class="header">
                <h1>æ”¯å‡ºè®°å½•æŸ¥è¯¢ - ç²¾å‡†æŸ¥å¾€æœŸ</h1>
            </div>
            <div class="filter-wrap">
                <div class="time-filter-box">
                    <div class="filter-item">
                        <label>è´¦å•å¹´åº¦ç­›é€‰</label>
                        <select class="filter-select" id="expYearFilter">
                            <option value="all" selected>æ‰€æœ‰å¹´ä»½</option>
                        </select>
                    </div>
                    <div class="filter-item">
                        <label>è´¦å•æœˆä»½ç­›é€‰</label>
                        <select class="filter-select" id="expMonthFilter">
                            <option value="all" selected>æ‰€æœ‰æœˆä»½</option>
                            <option value="1">1æœˆä»½</option>
                            <option value="2">2æœˆä»½</option>
                            <option value="3">3æœˆä»½</option>
                            <option value="4">4æœˆä»½</option>
                            <option value="5">5æœˆä»½</option>
                            <option value="6">6æœˆä»½</option>
                            <option value="7">7æœˆä»½</option>
                            <option value="8">8æœˆä»½</option>
                            <option value="9">9æœˆä»½</option>
                            <option value="10">10æœˆä»½</option>
                            <option value="11">11æœˆä»½</option>
                            <option value="12">12æœˆä»½</option>
                        </select>
                    </div>
                </div>
                <div class="cate-filter-box">
                    <div class="filter-item">
                        <label class="expense-label">æ”¯å‡ºåˆ†ç±»ç­›é€‰</label>
                        <!-- æ”¯å‡ºç­›é€‰ä¸‹æ‹‰æ¡†ï¼šå’Œè®°è´¦é¡µé¡ºåºä¸€è‡´ -->
                        <select class="filter-select" id="expCateFilter">
                            <option value="all" selected>å…¨éƒ¨æ”¯å‡º</option>
                            <option value="å€Ÿæ”¯">å€Ÿæ”¯</option>
                            <option value="é¤é¥®">é¤é¥®</option>
                            <option value="è´­ç‰©">è´­ç‰©</option>
                            <option value="ç½‘è´­">ç½‘è´­</option>
                            <option value="æ²¹è´¹">æ²¹è´¹</option>
                            <option value="ç”µè´¹">ç”µè´¹</option>
                            <option value="é¦™çƒŸ">é¦™çƒŸ</option>
                            <option value="æ¸¸æˆ">æ¸¸æˆ</option>
                            <option value="å…¶ä»–æ”¯å‡º">å…¶ä»–æ”¯å‡º</option>
                        </select>
                    </div>
                </div>
                <div class="filter-stats">
                    <div class="filter-stats-item expense">
                        <h3>ç­›é€‰åæ€»æ”¯å‡º</h3>
                        <p id="expFilterTotal">Â¥ 0.00</p>
                    </div>
                </div>
            </div>
            <div class="bill-list" id="expBillList">
                <div class="empty-tip">æš‚æ— æ”¯å‡ºè®°å½•ï¼Œå…ˆå»è®°è´¦å§ âœï¸</div>
            </div>
        </div>

        <!-- ============= ç¬¬ä¸‰é¡µé¢ã€æ”¶å…¥æŸ¥è¯¢é¡µã€‘- ç­›é€‰åæ€»æ”¶å…¥ç»Ÿè®¡ï¼ˆå«å€Ÿæ”¯ï¼‰ ============= -->
        <div class="page" id="page3">
            <div class="header">
                <h1>æ”¶å…¥è®°å½•æŸ¥è¯¢ - ç²¾å‡†æŸ¥å¾€æœŸ</h1>
            </div>
            <div class="filter-wrap">
                <div class="time-filter-box">
                    <div class="filter-item">
                        <label>è´¦å•å¹´åº¦ç­›é€‰</label>
                        <select class="filter-select" id="incYearFilter">
                            <option value="all" selected>æ‰€æœ‰å¹´ä»½</option>
                        </select>
                    </div>
                    <div class="filter-item">
                        <label>è´¦å•æœˆä»½ç­›é€‰</label>
                        <select class="filter-select" id="incMonthFilter">
                            <option value="all" selected>æ‰€æœ‰æœˆä»½</option>
                            <option value="1">1æœˆä»½</option>
                            <option value="2">2æœˆä»½</option>
                            <option value="3">3æœˆä»½</option>
                            <option value="4">4æœˆä»½</option>
                            <option value="5">5æœˆä»½</option>
                            <option value="6">6æœˆä»½</option>
                            <option value="7">7æœˆä»½</option>
                            <option value="8">8æœˆä»½</option>
                            <option value="9">9æœˆä»½</option>
                            <option value="10">10æœˆä»½</option>
                            <option value="11">11æœˆä»½</option>
                            <option value="12">12æœˆä»½</option>
                        </select>
                    </div>
                </div>
                <div class="cate-filter-box">
                    <div class="filter-item">
                        <label class="income-label">æ”¶å…¥åˆ†ç±»ç­›é€‰</label>
                        <!-- æ”¶å…¥ç­›é€‰ä¸‹æ‹‰æ¡†ï¼šæŒ‰è°ƒæ•´åé¡ºåºæ’åˆ— -->
                        <select class="filter-select" id="incCateFilter">
                            <option value="all" selected>å…¨éƒ¨æ”¶å…¥</option>
                            <option value="å€Ÿæ”¯">å€Ÿæ”¯</option>
                            <option value="å·¥èµ„">å·¥èµ„</option>
                            <option value="å…¼èŒ">å…¼èŒ</option>
                            <option value="çº¢åŒ…">çº¢åŒ…</option>
                            <option value="ç†è´¢">ç†è´¢</option>
                            <option value="å…¶ä»–æ”¶å…¥">å…¶ä»–æ”¶å…¥</option>
                        </select>
                    </div>
                </div>
                <div class="filter-stats">
                    <div class="filter-stats-item income">
                        <h3>ç­›é€‰åæ€»æ”¶å…¥</h3>
                        <p id="incFilterTotal">Â¥ 0.00</p>
                    </div>
                </div>
            </div>
            <div class="bill-list" id="incBillList">
                <div class="empty-tip">æš‚æ— æ”¶å…¥è®°å½•ï¼Œå…ˆå»è®°è´¦å§ âœï¸</div>
            </div>
        </div>
    </div>

    <script>
        const billType = document.getElementById('billType');
        const billCategory = document.getElementById('billCategory');
        const billMoney = document.getElementById('billMoney');
        const billDesc = document.getElementById('billDesc');
        const submitBtn = document.getElementById('submitBtn');
        const totalIncome = document.getElementById('totalIncome');
        const totalExpense = document.getElementById('totalExpense');
        const totalBalance = document.getElementById('totalBalance');
        const exportBtn = document.getElementById('exportBtn');
        const navBtns = document.querySelectorAll('.nav-btn');
        const pages = document.querySelectorAll('.page');
        // æ”¯å‡ºæŸ¥è¯¢ç›¸å…³
        const expYearFilter = document.getElementById('expYearFilter');
        const expMonthFilter = document.getElementById('expMonthFilter');
        const expCateFilter = document.getElementById('expCateFilter');
        const expBillList = document.getElementById('expBillList');
        const expFilterTotal = document.getElementById('expFilterTotal');
        // æ”¶å…¥æŸ¥è¯¢ç›¸å…³
        const incYearFilter = document.getElementById('incYearFilter');
        const incMonthFilter = document.getElementById('incMonthFilter');
        const incCateFilter = document.getElementById('incCateFilter');
        const incBillList = document.getElementById('incBillList');
        const incFilterTotal = document.getElementById('incFilterTotal');
        const themeBtn = document.getElementById('themeBtn');

        let editId = null;
        const STORAGE_KEY = 'bill_record_list';
        const THEME_KEY = 'bill_app_theme';
        const nowDate = new Date();
        const currentYear = nowDate.getFullYear();
        const currentMonth = nowDate.getMonth() + 1; // å½“å‰æœˆä»½ï¼ˆ1-12ï¼‰

        // ========== æ ¸å¿ƒä¿®æ”¹ï¼šè°ƒæ•´æ”¶æ”¯åˆ†ç±»çš„é¡ºåº ==========
        const categoryMap = {
            expense: [
                {name: 'å€Ÿæ”¯', value: 'å€Ÿæ”¯'},
                {name: 'é¤é¥®', value: 'é¤é¥®'},
                {name: 'è´­ç‰©', value: 'è´­ç‰©'},
                {name: 'ç½‘è´­', value: 'ç½‘è´­'},
                {name: 'æ²¹è´¹', value: 'æ²¹è´¹'},
                {name: 'ç”µè´¹', value: 'ç”µè´¹'},
                {name: 'é¦™çƒŸ', value: 'é¦™çƒŸ'},
                {name: 'æ¸¸æˆ', value: 'æ¸¸æˆ'},
                {name: 'å…¶ä»–æ”¯å‡º', value: 'å…¶ä»–æ”¯å‡º'}
            ],
            income: [
                {name: 'å€Ÿæ”¯', value: 'å€Ÿæ”¯'},
                {name: 'å·¥èµ„', value: 'å·¥èµ„'},
                {name: 'å…¼èŒ', value: 'å…¼èŒ'},
                {name: 'çº¢åŒ…', value: 'çº¢åŒ…'},
                {name: 'ç†è´¢', value: 'ç†è´¢'},
                {name: 'å…¶ä»–æ”¶å…¥', value: 'å…¶ä»–æ”¶å…¥'}
            ]
        };

        // ========== åˆå§‹åŒ– ==========
        initTheme();
        bindCategoryChange();
        initAllYearOptions();
        bindAllFilterEvents();
        bindPageNav();
        renderAllPageData();
        calcCurrentMonthTotal(); // é¦–é¡µè®¡ç®—å½“æœˆæ•°æ®

        // ========== äº‹ä»¶ç»‘å®š ==========
        submitBtn.addEventListener('click', handleSubmit);
        expBillList.addEventListener('click', handleBillAction);
        incBillList.addEventListener('click', handleBillAction);
        themeBtn.addEventListener('click', toggleTheme);
        exportBtn.addEventListener('click', exportBillData);

        // ========== æ ¸å¿ƒåŠŸèƒ½å‡½æ•° ==========
        function bindCategoryChange() {
            billType.addEventListener('change', function() {
                const type = this.value;
                const categorys = categoryMap[type];
                let html = '';
                categorys.forEach(item => html += `<option value="${item.value}">${item.name}</option>`);
                billCategory.innerHTML = html;
            });
        }
        function initTheme() {
            const theme = localStorage.getItem(THEME_KEY) || 'light';
            document.body.className = theme;
            themeBtn.textContent = theme === 'light' ? 'åˆ‡æ¢æ·±è‰²æ¨¡å¼' : 'åˆ‡æ¢æµ…è‰²æ¨¡å¼';
        }
        function toggleTheme() {
            const newTheme = document.body.className === 'light' ? 'dark' : 'light';
            document.body.className = newTheme;
            localStorage.setItem(THEME_KEY, newTheme);
            themeBtn.textContent = newTheme === 'light' ? 'åˆ‡æ¢æ·±è‰²æ¨¡å¼' : 'åˆ‡æ¢æµ…è‰²æ¨¡å¼';
        }
        function bindPageNav() {
            navBtns.forEach(btn => btn.addEventListener('click', function() {
                const pageId = this.dataset.page;
                navBtns.forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                pages.forEach(p => p.classList.remove('active'));
                document.getElementById(pageId).classList.add('active');
                renderAllPageData();
            }));
        }
        function initAllYearOptions() {
            const billData = getBillData();
            const yearSet = new Set();
            billData.forEach(item => yearSet.add(new Date(item.time).getFullYear()));
            yearSet.add(currentYear);
            const yearArr = Array.from(yearSet).sort((a,b)=>b-a);
            let yearHtml = '<option value="all" selected>æ‰€æœ‰å¹´ä»½</option>';
            yearArr.forEach(year => yearHtml += `<option value="${year}">${year}å¹´</option>`);
            expYearFilter.innerHTML = yearHtml;
            incYearFilter.innerHTML = yearHtml;
        }
        function bindAllFilterEvents() {
            // æ”¯å‡ºç­›é€‰äº‹ä»¶
            expYearFilter.addEventListener('change', () => renderExpPage());
            expMonthFilter.addEventListener('change', () => renderExpPage());
            expCateFilter.addEventListener('change', () => renderExpPage());
            // æ”¶å…¥ç­›é€‰äº‹ä»¶
            incYearFilter.addEventListener('change', () => renderIncPage());
            incMonthFilter.addEventListener('change', () => renderIncPage());
            incCateFilter.addEventListener('change', () => renderIncPage());
        }

        // ========== é¦–é¡µåªè®¡ç®—å½“æœˆæ”¶æ”¯ ==========
        function calcCurrentMonthTotal() {
            const billData = getBillData();
            let income = 0, expense = 0;
            billData.forEach(item => {
                const billDate = new Date(item.time);
                // åªç»Ÿè®¡å½“å‰å¹´ä»½+å½“å‰æœˆä»½çš„æ•°æ®
                if (billDate.getFullYear() === currentYear && billDate.getMonth() + 1 === currentMonth) {
                    if (item.type === 'income') {
                        income += item.money;
                    } else {
                        expense += Math.abs(item.money);
                    }
                }
            });
            const balance = income - expense;
            totalIncome.textContent = `Â¥ ${income.toFixed(2)}`;
            totalExpense.textContent = `Â¥ ${expense.toFixed(2)}`;
            totalBalance.textContent = `Â¥ ${balance.toFixed(2)}`;
        }

        // ========== æ”¯å‡ºæŸ¥è¯¢é¡µ - ç­›é€‰åæ•°æ®+æ€»æ”¯å‡ºç»Ÿè®¡ï¼ˆå«å€Ÿæ”¯ï¼‰ ==========
        function getFilteredExpData() {
            const allData = getBillData();
            const year = expYearFilter.value;
            const month = expMonthFilter.value;
            const cate = expCateFilter.value;
            return allData.filter(item => {
                if(item.type !== 'expense') return false;
                const billDate = new Date(item.time);
                const billYear = billDate.getFullYear();
                const billMonth = billDate.getMonth() + 1;
                const yearMatch = year === 'all' || billYear === parseInt(year);
                const monthMatch = month === 'all' || billMonth === parseInt(month);
                const cateMatch = cate === 'all' || item.category === cate;
                return yearMatch && monthMatch && cateMatch;
            });
        }
        function renderExpPage() {
            const expData = getFilteredExpData();
            // è®¡ç®—ç­›é€‰åæ€»æ”¯å‡º
            let total = 0;
            expData.forEach(item => total += Math.abs(item.money));
            expFilterTotal.textContent = `Â¥ ${total.toFixed(2)}`;

            // æ¸²æŸ“è´¦å•åˆ—è¡¨
            if (expData.length === 0) {
                const yearTxt = expYearFilter.value === 'all' ? 'æ‰€æœ‰å¹´ä»½' : `${expYearFilter.value}å¹´`;
                const monthTxt = expMonthFilter.value === 'all' ? 'æ‰€æœ‰æœˆä»½' : `${expMonthFilter.value}æœˆä»½`;
                const cateTxt = expCateFilter.value === 'all' ? 'å…¨éƒ¨æ”¯å‡º' : `ã€${expCateFilter.value}ã€‘`;
                expBillList.innerHTML = `<div class="empty-tip">æš‚æ— ${yearTxt}${monthTxt}çš„${cateTxt}è®°å½• âœï¸</div>`;
                return;
            }
            let html = '';
            expData.forEach(item => {
                html += `
                    <div class="bill-item" data-id="${item.id}">
                        <div class="bill-info">
                            <div class="bill-tag">
                                <span class="bill-type expense-type">æ”¯å‡º</span>
                                <span class="bill-category">${item.category}</span>
                            </div>
                            <div class="bill-money expense-money">Â¥ ${Math.abs(item.money).toFixed(2)}</div>
                            <div class="bill-desc">${item.desc}</div>
                            <div class="bill-time">${item.time}</div>
                        </div>
                        <div class="bill-actions">
                            <span class="edit-btn">âœï¸ ç¼–è¾‘</span>
                            <span class="del-btn">ğŸ—‘ï¸ åˆ é™¤</span>
                        </div>
                    </div>
                `;
            });
            expBillList.innerHTML = html;
        }

        // ========== æ”¶å…¥æŸ¥è¯¢é¡µ - ç­›é€‰åæ•°æ®+æ€»æ”¶å…¥ç»Ÿè®¡ï¼ˆå«å€Ÿæ”¯ï¼‰ ==========
        function getFilteredIncData() {
            const allData = getBillData();
            const year = incYearFilter.value;
            const month = incMonthFilter.value;
            const cate = incCateFilter.value;
            return allData.filter(item => {
                if(item.type !== 'income') return false;
                const billDate = new Date(item.time);
                const billYear = billDate.getFullYear();
                const billMonth = billDate.getMonth() + 1;
                const yearMatch = year === 'all' || billYear === parseInt(year);
                const monthMatch = month === 'all' || billMonth === parseInt(month);
                const cateMatch = cate === 'all' || item.category === cate;
                return yearMatch && monthMatch && cateMatch;
            });
        }
        function renderIncPage() {
            const incData = getFilteredIncData();
            // è®¡ç®—ç­›é€‰åæ€»æ”¶å…¥
            let total = 0;
            incData.forEach(item => total += item.money);
            incFilterTotal.textContent = `Â¥ ${total.toFixed(2)}`;

            // æ¸²æŸ“è´¦å•åˆ—è¡¨
            if (incData.length === 0) {
                const yearTxt = incYearFilter.value === 'all' ? 'æ‰€æœ‰å¹´ä»½' : `${incYearFilter.value}å¹´`;
                const monthTxt = incMonthFilter.value === 'all' ? 'æ‰€æœ‰æœˆä»½' : `${incMonthFilter.value}æœˆä»½`;
                const cateTxt = incCateFilter.value === 'all' ? 'å…¨éƒ¨æ”¶å…¥' : `ã€${incCateFilter.value}ã€‘`;
                incBillList.innerHTML = `<div class="empty-tip">æš‚æ— ${yearTxt}${monthTxt}çš„${cateTxt}è®°å½• âœï¸</div>`;
                return;
            }
            let html = '';
            incData.forEach(item => {
                html += `
                    <div class="bill-item" data-id="${item.id}">
                        <div class="bill-info">
                            <div class="bill-tag">
                                <span class="bill-type income-type">æ”¶å…¥</span>
                                <span class="bill-category">${item.category}</span>
                            </div>
                            <div class="bill-money income-money">Â¥ ${Math.abs(item.money).toFixed(2)}</div>
                            <div class="bill-desc">${item.desc}</div>
                            <div class="bill-time">${item.time}</div>
                        </div>
                        <div class="bill-actions">
                            <span class="edit-btn">âœï¸ ç¼–è¾‘</span>
                            <span class="del-btn">ğŸ—‘ï¸ åˆ é™¤</span>
                        </div>
                    </div>
                `;
            });
            incBillList.innerHTML = html;
        }

        function renderAllPageData() {
            initAllYearOptions();
            renderExpPage();
            renderIncPage();
        }
        function exportBillData() {
            const billData = getBillData();
            if (billData.length === 0) {
                alert('æš‚æ— è®°è´¦è®°å½•ï¼Œæ— éœ€å¯¼å‡ºï¼');
                return;
            }
            let csvContent = 'æ”¶æ”¯ç±»å‹,æ”¶æ”¯åˆ†ç±»,é‡‘é¢(å…ƒ),å¤‡æ³¨è¯´æ˜,è®°è´¦æ—¶é—´\n';
            billData.forEach(item => {
                const type = item.type === 'income' ? 'æ”¶å…¥' : 'æ”¯å‡º';
                const money = Math.abs(item.money).toFixed(2);
                const category = item.category || (item.type === 'income' ? 'å…¶ä»–æ”¶å…¥' : 'å…¶ä»–æ”¯å‡º');
                const desc = item.desc.replace(/,/g, 'ï¼Œ') || '';
                const time = item.time;
                csvContent += `${type},${category},${money},${desc},${time}\n`;
            });
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `è®°è´¦è®°å½•_${new Date().toLocaleDateString().replace(/\//g, '-')}.csv`;
            document.body.appendChild(link); link.click(); document.body.removeChild(link);
            alert('å¯¼å‡ºæˆåŠŸï¼æ–‡ä»¶å·²ä¸‹è½½åˆ°æœ¬åœ°ï½');
        }
        function getBillData() {
            return localStorage.getItem(STORAGE_KEY) ? JSON.parse(localStorage.getItem(STORAGE_KEY)) : [];
        }
        function saveBillData(list) {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(list));
            renderAllPageData();
            calcCurrentMonthTotal(); // æ–°å¢/ä¿®æ”¹åæ›´æ–°å½“æœˆç»Ÿè®¡
        }
        function handleSubmit() {
            const type = billType.value;
            const category = billCategory.value;
            const money = parseFloat(billMoney.value);
            const desc = billDesc.value.trim() || (type === 'income' ? 'æ”¶å…¥' : 'æ”¯å‡º');
            if (!money || money <= 0) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„é‡‘é¢ï¼');
                billMoney.focus();
                return;
            }
            const billData = getBillData();
            if (editId) {
                const editIndex = billData.findIndex(item => item.id === editId);
                billData[editIndex] = {...billData[editIndex], type, category, money: type === 'income' ? money : -money, desc};
                submitBtn.textContent = 'æ·»åŠ è®°è´¦è®°å½•';
                editId = null;
            } else {
                billData.unshift({id: Date.now(), type, category, money: type === 'income' ? money : -money, desc, time: new Date().toLocaleString('zh-CN')});
            }
            saveBillData(billData);
            resetForm();
        }
        function handleBillAction(e) {
            const target = e.target;
            const billItem = target.closest('.bill-item');
            if(!billItem) return;
            const id = parseInt(billItem.dataset.id);
            const billData = getBillData();
            const targetItem = billData.find(item => item.id === id);
            if (target.classList.contains('del-btn')) {
                if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°è´¦è®°å½•å—ï¼Ÿ')) saveBillData(billData.filter(item => item.id !== id));
            } else if (target.classList.contains('edit-btn')) {
                navBtns.forEach(b => b.classList.remove('active'));
                pages.forEach(p => p.classList.remove('active'));
                document.querySelector('[data-page="page1"]').classList.add('active');
                document.getElementById('page1').classList.add('active');
                editId = id;
                billType.value = targetItem.type;
                billType.dispatchEvent(new Event('change'));
                setTimeout(() => billCategory.value = targetItem.category, 10);
                billMoney.value = Math.abs(targetItem.money);
                billDesc.value = targetItem.desc;
                submitBtn.textContent = 'ç¡®è®¤ä¿®æ”¹è®°å½•';
                window.scrollTo(0, 0);
            }
        }
        function resetForm() {
            billType.value = 'expense';
            billType.dispatchEvent(new Event('change'));
            billMoney.value = '';
            billDesc.value = '';
            billMoney.focus();
        }
    </script>
</body>
</html>
